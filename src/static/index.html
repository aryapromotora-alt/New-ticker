<script>
    let currentRSSContent = '';

    async function convertNews() {
        const urlInput = document.getElementById('newsUrl');
        const convertBtn = document.getElementById('convertBtn');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const success = document.getElementById('success');
        const tickerContainer = document.getElementById('tickerContainer');
        const rssOutput = document.getElementById('rssOutput');

        const url = urlInput.value.trim();
        if (!url) {
            showError('Por favor, insira um URL válido do Google News.');
            return;
        }

        hideMessages();
        convertBtn.disabled = true;
        loading.style.display = 'block';
        tickerContainer.style.display = 'none';
        rssOutput.style.display = 'none';

        try {
            const response = await fetch(`/api/ticker/convert?url=${encodeURIComponent(url)}`);
            const rssContent = await response.text();

            if (rssContent.includes("<item>")) {
                showSuccess("✅ RSS gerado com sucesso!");
                displayRSS(rssContent);
                displayTicker(rssContent);
            } else {
                showError("Não foi possível gerar RSS válido.");
            }
        } catch (err) {
            showError("Erro de conexão. Tente novamente.");
            console.error("Erro:", err);
        } finally {
            convertBtn.disabled = false;
            loading.style.display = 'none';
        }
    }

    function displayTicker(rssContent) {
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(rssContent, "application/xml");
        const items = xmlDoc.getElementsByTagName("item");

        let tickerHTML = '';
        for (let i = 0; i < Math.min(items.length, 10); i++) {
            const title = items[i].getElementsByTagName("title")[0]?.textContent || "Sem título";
            const link = items[i].getElementsByTagName("link")[0]?.textContent || "#";

            tickerHTML += `
                <span class="news-item">
                    <a href="${link}" target="_blank" style="color:white; text-decoration:none;">
                        ${title}
                    </a>
                </span>
            `;
        }

        const tickerScroll = document.getElementById('tickerScroll');
        tickerScroll.innerHTML = tickerHTML;
        document.getElementById('tickerContainer').style.display = 'block';
        tickerScroll.style.animation = 'none';
        tickerScroll.offsetHeight; // força reflow
        tickerScroll.style.animation = 'scroll 40s linear infinite';
    }

    function displayRSS(rssContent) {
        const rssOutput = document.getElementById('rssOutput');
        const rssContentDiv = document.getElementById('rssContent');

        let preview = '';
        try {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(rssContent, "application/xml");
            const items = xmlDoc.getElementsByTagName("item");

            preview += "<ul style='list-style:none; padding-left:0'>";
            for (let i = 0; i < Math.min(items.length, 5); i++) {
                const title = items[i].getElementsByTagName("title")[0]?.textContent || "Sem título";
                const link = items[i].getElementsByTagName("link")[0]?.textContent || "#";

                preview += `
                    <li style="margin: 5px 0;">
                        <a href="${link}" target="_blank" style="color:#4285f4; text-decoration:none;">
                            ${title}
                        </a>
                    </li>
                `;
            }
            preview += "</ul>";
        } catch (e) {
            preview = "<p style='color:red'>Erro ao pré-visualizar RSS</p>";
        }

        currentRSSContent = rssContent;
        rssContentDiv.innerHTML = preview;
        rssOutput.style.display = 'block';
    }

    function copyRSS() {
        navigator.clipboard.writeText(currentRSSContent).then(() => {
            showSuccess("RSS copiado para a área de transferência!");
        }).catch(() => {
            showError("Erro ao copiar RSS.");
        });
    }

    function showError(message) {
        const error = document.getElementById('error');
        error.textContent = message;
        error.style.display = 'block';
    }

    function showSuccess(message) {
        const success = document.getElementById('success');
        success.textContent = message;
        success.style.display = 'block';
    }

    function hideMessages() {
        document.getElementById('error').style.display = 'none';
        document.getElementById('success').style.display = 'none';
    }

    document.getElementById('newsUrl').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') convertNews();
    });
</script>
